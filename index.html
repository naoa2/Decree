<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <title>Global Strategic Physics Research (GSPR) - Multi-Sector Suite</title>
    <style>
        :root { --neon: #00ff41; --sub: #008f11; --danger: #ff1100; --bg: #050505; --panel: #0d0d0d; }
        body { margin:0; background:var(--bg); color:var(--neon); font-family:'Share Tech Mono', 'Consolas', monospace; overflow:hidden; display:flex; font-size: 12px; }
        
        /* 認証・ログイン層 */
        #auth-gate { position:fixed; inset:0; background:#000; z-index:10000; display:flex; flex-direction:column; align-items:center; justify-content:center; }
        .login-box { border:1px solid var(--neon); padding:40px; background:#050505; text-align:center; box-shadow:0 0 30px var(--sub); }
        .input-line { background:transparent; border:none; border-bottom:1px solid var(--neon); color:var(--neon); padding:10px; text-align:center; font-size:18px; width:280px; outline:none; margin:15px 0; }

        /* サイドパネル */
        #sidebar { width:350px; border-right:1px solid #333; background:var(--panel); display:flex; flex-direction:column; padding:15px; overflow-y:auto; }
        .user-tag { background:var(--sub); color:#000; padding:8px; font-weight:bold; margin-bottom:10px; font-size:14px; letter-spacing:1px; }
        .budget-sec { margin-bottom: 20px; border-bottom: 1px solid #222; padding-bottom: 15px; }
        .budget-sec h4 { color: #fff; margin: 10px 0; border-left: 3px solid var(--neon); padding-left: 8px; font-size:11px; }
        
        .item-box { background: #151515; padding:10px; margin-bottom: 8px; border: 1px solid #222; }
        .cost { color: #ffd700; font-weight: bold; }
        
        /* ゲームビュー */
        #viewport { flex-grow:1; display:flex; justify-content:center; align-items:center; position:relative; background:#000; }
        #canvas-wrap { position:relative; width:450px; height:700px; border:2px solid #222; box-shadow:0 0 40px rgba(0,255,65,0.05); }

        /* ボタン・パーツ */
        .btn-action { background:transparent; color:var(--neon); border:1px solid var(--neon); padding:8px; cursor:pointer; width:100%; margin-top:5px; font-family:inherit; }
        .btn-action:hover:not(:disabled) { background:var(--neon); color:#000; }
        .btn-action:disabled { color:#444; border-color:#444; cursor:default; }
        
        .sector-btn { background:#111; color:var(--neon); border:1px solid var(--neon); padding:8px; margin:3px; cursor:pointer; width:75px; font-size:9px; }
        .sector-btn.active { background:var(--neon); color:#000; box-shadow:0 0 10px var(--neon); }

        /* ダミー報告書 */
        #dummy { position:fixed; inset:0; background:#fff; color:#333; z-index:20000; display:none; padding:60px; font-family:serif; line-height:1.6; }
    </style>
</head>
<body>

    <!-- 認証・ログイン -->
    <div id="auth-gate">
        <div class="login-box" id="login-step1">
            <p>GSPR_NETWORK: 研究員IDを入力してください</p>
            <input type="text" id="researcher-id" class="input-line" placeholder="RESEARCHER_NAME">
            <button class="btn-action" onclick="toStep2()">ENTER_NAME</button>
        </div>
        <div class="login-box" id="login-step2" style="display:none;">
            <p>SECURITY_KEY: 認証コードを入力</p>
            <input type="password" id="pw" class="input-line">
            <button class="btn-action" onclick="verifyLogin()">VERIFY_IDENTITY</button>
        </div>
    </div>

    <!-- 緊急回避ダミー -->
    <div id="dummy">
        <h1>国立物理研究所 予算執行およびシミュレーション解析報告書</h1>
        <hr>
        <p>令和8年度における量子力学を応用した弾性体移動モデルの研究成果を以下の通り報告する。</p>
        <table border="1" style="width:100%; border-collapse:collapse; background:white;">
            <tr style="background:#ddd;"><td>分析セクター</td><td>重力係数</td><td>観測ステータス</td></tr>
            <tr><td>SEC-01</td><td>0.45</td><td>正常</td></tr>
            <tr><td>SEC-02</td><td>0.18</td><td>低重力環境</td></tr>
        </table>
    </div>

    <!-- サイドバー -->
    <div id="sidebar">
        <div class="user-tag" id="user-display">ID: UNKNOWN</div>
        
        <div class="budget-sec" style="background:#000; padding:10px;">
            TOTAL_CREDIT: <br>
            <span id="res-ui" style="font-size:24px; color:#ffd700;">0</span> <small>RC</small>
        </div>

        <div class="budget-sec">
            <h4>[1] SECTOR_SELECT (物理環境切替)</h4>
            <div style="display:flex; flex-wrap:wrap; justify-content:center;">
                <button class="sector-btn active" id="sbtn-0" onclick="setSector(0)">LAB</button>
                <button class="sector-btn" id="sbtn-1" onclick="setSector(1)">MOON</button>
                <button class="sector-btn" id="sbtn-2" onclick="setSector(2)">DEEP</button>
                <button class="sector-btn" id="sbtn-3" onclick="setSector(3)">NULL</button>
            </div>
        </div>

        <div class="budget-sec">
            <h4>[2] LOW_COST_RESEARCH (消耗品)</h4>
            <div class="item-box">
                <b>分析効率化チップ (v1)</b><br>
                獲得量 1.5倍 | <span class="cost">1,500 RC</span>
                <button class="btn-action" id="b-a1" onclick="buy('a1')">APPROVE</button>
            </div>
            <div class="item-box">
                <b>分子間反発エンジン (Lv.<span id="lv-j">1</span>)</b><br>
                跳躍力向上 | <span class="cost"><span id="c-j">500</span> RC</span>
                <button class="btn-action" onclick="buy('j')">UPGRADE</button>
            </div>
        </div>

        <div class="budget-sec">
            <h4>[3] STRATEGIC_INVESTMENT (国家プロジェクト)</h4>
            <div class="item-box">
                <b>磁場展開大型コイル (磁力)</b><br>
                全セクター対応 | <span class="cost">50,000 RC</span>
                <button class="btn-action" id="b-b1" onclick="buy('b1')">APPROVE</button>
            </div>
            <div class="item-box">
                <b>軌道エレベーター・システム</b><br>
                無限リスポーン | <span class="cost">1,000,000 RC</span>
                <button class="btn-action" id="b-s1" onclick="buy('s1')">APPROVE</button>
            </div>
        </div>
    </div>

    <!-- メインビュー -->
    <div id="viewport">
        <div id="canvas-wrap">
            <canvas id="c"></canvas>
            <div id="menu" style="position:absolute; inset:0; background:rgba(0,0,0,0.9); display:flex; flex-direction:column; align-items:center; justify-content:center;">
                <h1 id="sector-title" style="color:#fff; font-size:24px; letter-spacing:4px;">LAB_ENVIRONMENT</h1>
                <button class="btn-action" style="width:200px; height:50px; font-size:18px;" onclick="startSim()">EXECUTE_SIM</button>
            </div>
            <div id="hud" style="position:absolute; top:15px; left:15px; pointer-events:none; display:none;">
                <div style="border-left:2px solid var(--neon); padding-left:10px; background:rgba(0,0,0,0.5);">
                    ALT: <span id="alt-ui" style="color:#fff;">0</span>m<br>
                    RES: <span id="coins-ui" style="color:#ffd700;">0</span>
                </div>
            </div>
        </div>
    </div>

<script>
const canvas = document.getElementById('c');
const ctx = canvas.getContext('2d');
canvas.width = 450; canvas.height = 700;

let currentResearcher = "";
let data = { res: 0, lvJ: 1, a1: false, b1: false, s1: false, sector: 0, best: 0 };

const sectorParams = [
    { name: "LAB_ENVIRONMENT", g: 0.45, air: 0.85, jump: -14, bg: "#050505" },
    { name: "LUNAR_BASE", g: 0.18, air: 0.98, jump: -10, bg: "#0a0a15" },
    { name: "DEEP_SEA_ANALYSIS", g: 0.3, air: 0.6, jump: -18, bg: "#000510" },
    { name: "NULL_SINGULARITY", g: 0.8, air: 0.9, jump: -16, bg: "#000" }
];

// --- 認証・データ管理 ---
function toStep2() {
    const id = document.getElementById('researcher-id').value.trim();
    if(id) { currentResearcher = id; document.getElementById('login-step1').style.display='none'; document.getElementById('login-step2').style.display='block'; }
}

function verifyLogin() {
    if(document.getElementById('pw').value === 'neba72') {
        document.getElementById('auth-gate').style.display='none';
        loadData();
    }
}

function loadData() {
    const saved = localStorage.getItem('gspr_v20_' + currentResearcher);
    if(saved) data = JSON.parse(saved);
    document.getElementById('user-display').innerText = `ID: ${currentResearcher}`;
    updateUI();
}

function saveData() { localStorage.setItem('gspr_v20_' + currentResearcher, JSON.stringify(data)); }

function updateUI() {
    document.getElementById('res-ui').innerText = data.res.toLocaleString();
    document.getElementById('lv-j').innerText = data.lvJ;
    document.getElementById('c-j').innerText = data.lvJ * 500;
    if(data.a1) document.getElementById('b-a1').disabled = true;
    if(data.b1) document.getElementById('b-b1').disabled = true;
    if(data.s1) document.getElementById('b-s1').disabled = true;
    setSector(data.sector);
}

function buy(id) {
    let cost = 0;
    if(id==='j') cost = data.lvJ * 500;
    if(id==='a1') cost = 1500;
    if(id==='b1') cost = 50000;
    if(id==='s1') cost = 1000000;

    if(data.res >= cost) {
        data.res -= cost;
        if(id==='j') data.lvJ++; else data[id] = true;
        saveData(); updateUI();
    }
}

function setSector(id) {
    data.sector = id;
    document.querySelectorAll('.sector-btn').forEach(b => b.classList.remove('active'));
    document.getElementById(`sbtn-${id}`).classList.add('active');
    document.getElementById('sector-title').innerText = sectorParams[id].name;
    saveData();
}

// --- ゲームエンジン ---
const state = { active: false, score: 0, coins: 0, platforms: [], items: [] };
const player = { x: 200, y: 550, vx: 0, dy: 0, sq: 1 };
const keys = {};

window.onkeydown = (e) => { 
    if(e.key === 'Escape') { const d=document.getElementById('dummy'); d.style.display=(d.style.display==='none')?'block':'none'; }
    keys[e.code] = true; 
};
window.onkeyup = (e) => keys[e.code] = false;

function startSim() {
    document.getElementById('menu').style.display='none';
    document.getElementById('hud').style.display='block';
    state.active = true; state.score = 0; state.coins = 0;
    state.platforms = [{x:0, y:650, w:450, h:50, type:'base', s:0}];
    for(let i=1; i<10; i++) state.platforms.push(genP(650-i*85));
    player.y = 550; player.dy = 0;
}

function genP(y) {
    let w = (data.sector === 3) ? 40 : Math.max(30, 85 - (state.score/400));
    return { x: Math.random()*(450-w), y, w, h: 12, s: (Math.random()-0.5)*(state.score/600), type:'norm' };
}

function update() {
    if(!state.active) return;
    let s = sectorParams[data.sector];

    if(keys['ArrowLeft']) player.vx = -7; else if(keys['ArrowRight']) player.vx = 7; else player.vx *= s.air;
    player.x += player.vx; player.dy += s.g; player.y += player.dy;
    player.sq = player.dy < 0 ? 0.75 : 1.2;

    if(player.x < -30) player.x = 430; if(player.x > 430) player.x = -30;

    if(player.dy > 0) {
        state.platforms.forEach(p => {
            p.x += p.s; if(p.x<0 || p.x+p.w > 450) p.s*=-1;
            if(player.x+40 > p.x && player.x+10 < p.x+p.w && player.y+60 > p.y && player.y+60 < p.y+15) {
                player.dy = (p.type==='base') ? -24 : s.jump - (data.lvJ * 0.4);
                player.sq = 1.5;
            }
        });
    }

    if(Math.random() < 0.03) state.items.push({x: Math.random()*430, y:-20});
    state.items.forEach((it, i) => {
        it.y += 3;
        if(data.b1) { // 磁力
            let dx = (player.x+25) - it.x, dy = (player.y+30) - it.y;
            let d = Math.sqrt(dx*dx+dy*dy);
            if(d < 200) { it.x += dx/10; it.y += dy/10; }
        }
        if(Math.abs(player.x+25-it.x)<40 && Math.abs(player.y+30-it.y)<45) {
            state.coins += data.a1 ? 15 : 10; state.items.splice(i,1);
        }
    });

    if(player.y < 350) {
        let diff = 350 - player.y; player.y = 350;
        state.score += Math.floor(diff/2);
        state.platforms.forEach(p => { p.y += diff; if(p.y>700) Object.assign(p, genP(-50)); });
        state.items.forEach(it => it.y += diff);
    }

    if(player.y > 750) {
        if(data.s1) { player.y = 100; player.dy = 0; }
        else {
            state.active = false; data.res += state.coins;
            if(state.score > data.best) data.best = state.score;
            saveData(); updateUI();
            document.getElementById('menu').style.display='flex';
        }
    }
}

function draw() {
    let s = sectorParams[data.sector];
    ctx.fillStyle = s.bg; ctx.fillRect(0,0,450,700);
    ctx.strokeStyle = "rgba(0,255,65,0.05)";
    for(let i=0; i<450; i+=50) { ctx.beginPath(); ctx.moveTo(i,0); ctx.lineTo(i,700); ctx.stroke(); }

    state.platforms.forEach(p => {
        ctx.fillStyle = p.type==='base' ? "var(--neon)" : "#222";
        ctx.fillRect(p.x, p.y, p.w, p.h);
    });
    state.items.forEach(it => {
        ctx.fillStyle = "#ffd700"; ctx.beginPath(); ctx.arc(it.x, it.y, 6, 0, 7); ctx.fill();
    });

    ctx.save(); ctx.translate(player.x+25, player.y+60); ctx.scale(1/player.sq, player.sq);
    ctx.fillStyle = "#8d6e63"; ctx.beginPath(); ctx.roundRect(-25,-60,50,60,8); ctx.fill();
    ctx.restore();

    document.getElementById('alt-ui').innerText = state.score;
    document.getElementById('coins-ui').innerText = state.coins;
}

function loop() { update(); draw(); requestAnimationFrame(loop); }
loop();
</script>
</body>
</html>
